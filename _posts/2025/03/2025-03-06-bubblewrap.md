---
layout: post
title: Утилита изоляции процессов Bubblewrap
date: 2025-03-06
tags: tools devops untrusted_code
categories: post
thumbnail: /assets/img/blog/2025/2025-03-07-bubblewrapjpg.jpg
---

Представьте, что вам нужно запустить некоторый процесс Linux в изолированной среде. Так, чтобы он не смог нанести вред системе, на которой запускается. Какие инструменты мы используем в таких случаях? Первое, что приходит в голову, это технологии виртуализации или контейнеризации. Но что если нам нужно что-то более *легковесное* и *простое* в использовании? На самом деле такой инструмент есть - это утилита командной строки [Bubblewrap](https://github.com/containers/bubblewrap), один из проектов сообщества [Containers](https://github.com/containers) (знаменито авторством таких инструментов, как Podman, Buildah, Skopeo и др.).

![](/assets/img/blog/2025/2025-03-07-bubblewrapjpg.jpg)

Когда может быть полезен:
* Невысокие требования к изоляции процесса и системы.
* Недопустимы накладные расходы как у более сложных средств изоляции.
* Тестирование (поведения) программы в разных условиях эксплуатации.
* Запуск программ/скриптов/кода, полученных из ненадежных источников.
* Лимитирование расхода ресурсов для отдельно взятого процесса.
* Изменение структуры файловой системы для запускаемого процесса.
* Разработка изолированных сред типа [Flatpack](https://github.com/flatpak/flatpak).

Установка:
```sh
apt-get install bubblewrap
```

Использование:
```sh
bwrap --ro-bind / / echo 'Hello, Bubblewrap!'
```

В приведенном примере команда `echo` выполнится в изолированной среде, в которой структура файловой системы один к одному повторяет структуру host-машины, однако файлы в ней будут доступны только для чтения (`--ro-bind`, read-only bind). Поэтому следующая команда:
```sh
bwrap --ro-bind / / sh -c 'echo Hello, Bubblewrap! > /tmp/out.txt'
```

 выдаст ошибку:
```
sh: 1: cannot create /tmp/out.txt: Read-only file system
```

На самом деле `bwrap` имеет кучу настроек, используя которые можно ограничить очень многие аспекты запускаемого процесса, включая использование ресурсов системы и даже вызов указанных системных функций. Чтобы быстрей сориентироваться, как ей пользоваться, можно посмотреть [примеры](https://github.com/valoq/bwscripts) изоляции некоторых популярных программ.

Таким образом, используя аргументы командной строки, вы *сами определяете уровень изоляции запускаемого процесса.* При этом под капотом Bubblewrap использует стандартные средства Linux, которые *не требуют повышения привилегий* пользователя: [chroot](https://linux.die.net/man/2/chroot), [clone](https://linux.die.net/man/2/clone), [seccomp](https://linux.die.net/man/2/prctl), [cgroups](https://man7.org/linux/man-pages/man7/cgroups.7.html), [landlock](https://man7.org/linux/man-pages/man7/landlock.7.html). 

Основные плюсы:
* Не требуются root-привилегии.
* Изолирует работу только одного процесса.
* Может использоваться для изоляции приложений с графическим UI.
* Предоставляет большой спектр настроек лимитирования.
* Простая установка и использование.
* Низкие накладные расходы на изоляцию.

Основной минус - это то, что ограничение на ресурсы системы устанавливаются только с использованием cgroup. Это значит, что для полноценной работы `bwrap` в Docker/Kubernetes-контейнере последний придется запустить в privileged-режиме или лучше с указанием в capabilities привилегии `SYS_ADMIN`.

***

Берегите себя, изолируйте свои процессы и будьте в безопасности! ;-)
