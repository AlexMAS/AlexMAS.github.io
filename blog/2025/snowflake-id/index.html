<!DOCTYPE html> <html lang="ru"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Snowflake ID: генерация целочисленного идентификатора в распределённой системе | Александр Межов </title> <meta name="author" content="Александр Межов"> <meta name="description" content="Доказано, что каждая снежинка имеет уникальную структуру. Разработчики Twitter вдохновились этим феноменом и изобрели Snowflake ID — целочисленный глобально-уникальный идентификатор."> <meta name="keywords" content="architecture, development, blog, Mezhov, Межов"> <meta property="og:site_name" content="Александр Межов"> <meta property="og:type" content="article"> <meta property="og:title" content="Snowflake ID: генерация целочисленного идентификатора в распределённой системе"> <meta property="og:url" content="https://alexmas.github.io//blog/2025/snowflake-id/"> <meta property="og:description" content="Доказано, что каждая снежинка имеет уникальную структуру. Разработчики Twitter вдохновились этим феноменом и изобрели Snowflake ID — целочисленный глобально-уникальный идентификатор."> <meta property="og:image" content="https://alexmas.github.io//assets/img/blog/2025/2025-07-24-snowflake-id.jpg"> <meta property="og:locale" content="ru"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Snowflake ID: генерация целочисленного идентификатора в распределённой системе"> <meta name="twitter:description" content="Доказано, что каждая снежинка имеет уникальную структуру. Разработчики Twitter вдохновились этим феноменом и изобрели Snowflake ID — целочисленный глобально-уникальный идентификатор."> <meta name="twitter:image" content="https://alexmas.github.io//assets/img/blog/2025/2025-07-24-snowflake-id.jpg"> <script type="application/ld+json">
    {
        "author":
        {
            "@type": "Person",
            "name": "Александр Межов"
        },
        "url": "https://alexmas.github.io//blog/2025/snowflake-id/",
        "@type": "BlogPosting",
        "description": "Доказано, что каждая снежинка имеет уникальную структуру. Разработчики Twitter вдохновились этим феноменом и изобрели Snowflake ID — целочисленный глобально-уникальный идентификатор.",
        "headline": "Snowflake ID: генерация целочисленного идентификатора в распределённой системе",
        
        "sameAs": "https://t.me/arch_and_dev",
        
        "name": "Александр Межов",
        "@context": "https://schema.org"
    }
  </script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?27787be15f1341be1c13406838f8df52"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://alexmas.github.io//blog/2025/snowflake-id/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Александр</span> Межов </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">Обо мне </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Архитектоника в ИТ </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Публикации и выступления </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Snowflake ID: генерация целочисленного идентификатора в распределённой системе</h1> <p class="post-meta"> </p> <p class="post-tags"> <a href="/blog/2025"><i class="fa-solid fa-calendar fa-sm"></i> 2025</a>-07-24   ·   <a href="/blog/tag/tip"> <i class="fa-solid fa-hashtag fa-sm"></i> tip</a>   <a href="/blog/tag/db"> <i class="fa-solid fa-hashtag fa-sm"></i> db</a>   ·   <a href="/blog/category/post"> <i class="fa-solid fa-tag fa-sm"></i> post</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><a href="https://www.its.caltech.edu/~atomic/snowcrystals/alike/alike.htm" rel="external nofollow noopener" target="_blank">Доказано</a>, что каждая снежинка имеет уникальную структуру. Разработчики Twitter вдохновились этим феноменом и изобрели Snowflake ID — целочисленный глобально-уникальный идентификатор.</p> <p><img src="/assets/img/blog/2025/2025-07-24-snowflake-id.jpg" alt=""></p> <h2 id="контекст-и-проблема">Контекст и проблема</h2> <p>Проблематика хорошо описана в моём предыдущем <a href="/blog/2025/lamport-timestamp/">посте про Lamport Timestamp</a>, поэтому здесь сразу перейдём к основной части.</p> <h2 id="решение">Решение</h2> <p>Структура 64-битного идентификатора (от старшего бита к младшему):</p> <ul> <li> <code class="language-plaintext highlighter-rouge">Sign</code> (1 бит). Знаковый бит.</li> <li> <code class="language-plaintext highlighter-rouge">Timestamp</code> (41 бит). Количество миллисекунд от какой-либо даты. Такой размерности хватит на 69 лет. Например, если за начало отсчета взять Unit Time Epoch, генерация без переполнения будет до 2039 года. Однако правую границу можно сместить, сместив вправо точку отсчета времени.</li> <li> <code class="language-plaintext highlighter-rouge">Datacenter ID</code> (5 бит). Идентификатор ЦОД (до 32 ЦОД).</li> <li> <code class="language-plaintext highlighter-rouge">Machine ID</code> (5 бит). Идентификатор узла в каждом ЦОД (до 32 машин).</li> <li> <code class="language-plaintext highlighter-rouge">Machine Sequence Number</code> (12 бит). Счётчик генераций, который сбрасывается каждую миллисекунду (4096000 генераций в секунду на каждом узле).</li> </ul> <p>В зависимости от потребностей размерность полей может варьироваться. Например, если требуется более длительное хранение данных (более 69 лет), можно увеличить размерность поля <code class="language-plaintext highlighter-rouge">Timestamp</code>. Изменение на 1 бит изменяет диапазон в 2 раза (42 бита — 139 лет, 43 бита — 278 лет и т.д.; аналогично в обратную сторону). Изменить размерность полей можно за счет размерности счётчика генераций. Если в системе генерации редкие (и нет значительных всплесков), то 12 разрядов слишком много.</p> <p>Для закрепления материала приготовил рабочий <a href="https://gist.github.com/AlexMAS/165d3ad3706c1806ce4b2eecaff0769c" rel="external nofollow noopener" target="_blank">пример на Java</a>. Он очень простой, его можно портировать на любой другой язык. Забирайте, улучшайте, делитесь опытом и впечатлениями. ;-)</p> <h2 id="плюсы">Плюсы</h2> <ul> <li>Скорость генерации.</li> <li>Автономность генерации.</li> <li>Растущая по времени последовательность.</li> <li>Компактный глобально-уникальный идентификатор (в 2 раза меньше UUID).</li> </ul> <p>Помимо прочего, всё это создаёт благоприятные условия для использования Snowflake ID в качестве ключа для B-Tree. Напомню, ранее я делал <a href="/blog/2025/selecting-b-tree-and-uuids/">исследование</a> на тему выбора оптимального ключа для B-Tree. Поведение Snowflake ID будет идентично целочисленному идентификатору.</p> <h2 id="минусы">Минусы</h2> <ul> <li> <em>Ошибки или задержки генерации при прыжках времени назад.</em> Неявно предполагается, что часы на рабочем узле всегда двигаются только вперед. Мы все знаем, что это не всегда так. Во-первых, так называемый <a href="https://en.wikipedia.org/wiki/Clock_drift" rel="external nofollow noopener" target="_blank">Clock Drift</a> характерен для любых часов. Часы работают с непостоянной частотой, которая в том числе зависит от нагрузки на систему. Во-вторых, Multi-Core/Multi-Socket серверы могут иметь отдельный таймер на каждое ядро, и они не обязательно синхронизированы друг с другом (см. <a href="https://steveloughran.blogspot.com/2015/09/time-on-multi-core-multi-socket-servers.html" rel="external nofollow noopener" target="_blank">Time on Multi-Core, Multi-Socket Servers</a>). Вполне возможны случаи, когда последовательные обращения к Monotonic Clock (например, с помощью <code class="language-plaintext highlighter-rouge">System.nanotime()</code>) будут приводить к прыжкам во времени из-за того, что код выполнялся на разных ядрах. В общем случае на уровне прикладного кода выходом может служить механизм привязки к процессору (<a href="https://en.wikipedia.org/wiki/Processor_affinity" rel="external nofollow noopener" target="_blank">Process Affinity</a>). Наконец, часы типа Time-of-Day благодаря <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" rel="external nofollow noopener" target="_blank">NTP</a> регулярно совершают прыжки во времени.</li> <li> <em>Генерируемое множество не является множеством натуральных чисел.</em> Иначе говоря, отсчет начинается не с 0 и далее по порядку, а с гораздо большего числа, которое обязано должно быть 64-разрядным.</li> <li> <em>Возможны коллизии.</em> Если два одновременно работающих узла будут иметь одинаковые Datacenter ID и Machine ID. Такое возможно, если один узел постепенно выводится из работы и заменяется своим “клоном”.</li> <li> <em>Раскрытие особенностей.</em> Из идентификатора можно получить представление об инфраструктуре (количество ЦОД и узлов).</li> </ul> <hr> <p>Перечисленные недостатки вполне решаемы или терпимы. Например, в своей реализации я обрабатываю прыжки времени. Понравился ли вам алгоритм?</p> </div> </article> <br> <br> <div class="card"> <div class="card-body"> <h4 class="card-title">Понравилась статья?</h4> <p class="card-text"> Посмею напомнить, что у меня есть Telegram-канал <a href="https://t.me/arch_and_dev/79" rel="external nofollow noopener" target="_blank">Архитектоника в ИТ</a>, где я публикую материал на похожие темы примерно раз в неделю. Подписчики меня мотивируют, но ещё больше мотивируют живые дискуссии, ведь именно в них рождается истина. Поэтому подписывайтесь на канал и будем оставаться на связи! ;-) </p> <p class="card-text">Статьи из той же категории:</p> <ul class="list-disc pl-8"> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/search-for-medical-documents/">Первичный анализ задачи поиска медицинских документов</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ontico-conf-transformation/">Трансформация конференций</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/9-fallacies-distributed-computing/">9 архитектурных заблуждений о распределённых системах</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/connascence/">Порочные связи между компонентами</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/decomposition-in-the-style-of-quantum-architecture/">Декомпозиция в стиле квантовой архитектуры</a> </p> </li> </ul> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Александр Межов. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Напечатайте что-нибудь для поиска"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>