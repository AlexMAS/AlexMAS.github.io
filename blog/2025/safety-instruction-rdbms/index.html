<!DOCTYPE html> <html lang="ru"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Меры предосторожности при работе с РСУБД | Александр Межов </title> <meta name="author" content="Александр Межов"> <meta name="description" content="В пылу сражения легко забыть базовые меры предосторожности. Именно по этой причине разговоры о подобных вещах всегда актуальны. Предлагаю пройтись по базовым рекомендациям при работе с РСУБД. За основу взят зажигательный доклад “Хайлоад на ровном месте” и дополнен моими комментариями."> <meta name="keywords" content="architecture, development, blog, Mezhov, Межов"> <meta property="og:site_name" content="Александр Межов"> <meta property="og:type" content="article"> <meta property="og:title" content="Меры предосторожности при работе с РСУБД"> <meta property="og:url" content="https://alexmas.github.io//blog/2025/safety-instruction-rdbms/"> <meta property="og:description" content="В пылу сражения легко забыть базовые меры предосторожности. Именно по этой причине разговоры о подобных вещах всегда актуальны. Предлагаю пройтись по базовым рекомендациям при работе с РСУБД. За основу взят зажигательный доклад “Хайлоад на ровном месте” и дополнен моими комментариями."> <meta property="og:image" content="https://alexmas.github.io//assets/img/blog/2025/2025-11-11-safety-instruction-rdbms.jpg"> <meta property="og:locale" content="ru"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Меры предосторожности при работе с РСУБД"> <meta name="twitter:description" content="В пылу сражения легко забыть базовые меры предосторожности. Именно по этой причине разговоры о подобных вещах всегда актуальны. Предлагаю пройтись по базовым рекомендациям при работе с РСУБД. За основу взят зажигательный доклад “Хайлоад на ровном месте” и дополнен моими комментариями."> <meta name="twitter:image" content="https://alexmas.github.io//assets/img/blog/2025/2025-11-11-safety-instruction-rdbms.jpg"> <script type="application/ld+json">
    {
        "author":
        {
            "@type": "Person",
            "name": "Александр Межов"
        },
        "url": "https://alexmas.github.io//blog/2025/safety-instruction-rdbms/",
        "@type": "BlogPosting",
        "description": "В пылу сражения легко забыть базовые меры предосторожности. Именно по этой причине разговоры о подобных вещах всегда актуальны. Предлагаю пройтись по базовым рекомендациям при работе с РСУБД. За основу взят зажигательный доклад “Хайлоад на ровном месте” и дополнен моими комментариями.",
        "headline": "Меры предосторожности при работе с РСУБД",
        
        "sameAs": "https://t.me/arch_and_dev",
        
        "name": "Александр Межов",
        "@context": "https://schema.org"
    }
  </script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?27787be15f1341be1c13406838f8df52"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://alexmas.github.io//blog/2025/safety-instruction-rdbms/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Александр</span> Межов </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">Обо мне </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Архитектоника в ИТ </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Публикации и выступления </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Меры предосторожности при работе с РСУБД</h1> <p class="post-meta"> </p> <p class="post-tags"> <a href="/blog/2025"><i class="fa-solid fa-calendar fa-sm"></i> 2025</a>-11-11   ·   <a href="/blog/tag/tip"> <i class="fa-solid fa-hashtag fa-sm"></i> tip</a>   <a href="/blog/tag/dev"> <i class="fa-solid fa-hashtag fa-sm"></i> dev</a>   <a href="/blog/tag/devops"> <i class="fa-solid fa-hashtag fa-sm"></i> devops</a>   ·   <a href="/blog/category/post"> <i class="fa-solid fa-tag fa-sm"></i> post</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>В пылу сражения легко забыть базовые меры предосторожности. Именно по этой причине разговоры о подобных вещах всегда актуальны. Предлагаю пройтись по базовым рекомендациям при работе с РСУБД. За основу взят зажигательный доклад “<a href="https://highload.ru/moscow/2025/abstracts/16855" rel="external nofollow noopener" target="_blank">Хайлоад на ровном месте</a>” и дополнен моими комментариями.</p> <p><img src="/assets/img/blog/2025/2025-11-11-safety-instruction-rdbms.jpg" alt=""></p> <ul> <li> <p>Количество соединений с БД — это ограниченный ресурс, который контролируется как со стороны БД, так и со стороны приложения. Чем больше параллельных обращений к БД, тем больше должен быть пул соединений; иначе тот, кому не досталось соединения, зависнет до появления свободного соединения. Это значит, что будут таймауты, рост числа wait-потоков, рост потребления памяти (как минимум, на стек), рост потребления CPU (как минимум, на переключение контекста) и множество ярких эмоций.</p> </li> <li> <p>Idle-соединение — это неактивное соединение, которое захватило приложение, но не использует его. Например, захват соединения, затем длительные вычисления (или даже <em>поход во внешние сервисы</em>), и только в конце работа с БД. При таком подходе пул соединений будет израсходован очень быстро, и указанные выше проблемы возникнут практически сразу.</p> </li> <li> <p>Idle-in-transaction-соединение — это idle-соединение, в котором начали выполнение транзакции. Чаще всего такое провоцируют фреймворки. Например, аннотация <code class="language-plaintext highlighter-rouge">@Transactional</code> была помещена на верхний уровень процесса обработки запроса и захватывает не только работу с БД. Ко всем вышеуказанным проблемам сюда можно смело докидывать увеличение времени транзакции, длительные блокировки в БД, расходы на хранение версий (MVCC), раздувание WAL (Wall-Ahead Log).</p> </li> </ul> <blockquote> <p>Для “защиты” PostgreSQL от неблагонадёжных приложений разработан <a href="https://github.com/pgbouncer/pgbouncer" rel="external nofollow noopener" target="_blank">PgBouncer</a>, который проксирует взаимодействие с базой с целью пулинга соединений. Он позволяет активным соединениям вытеснять idle-соединения (но не idle-in-transaction), что увеличивает пропускную способность.</p> </blockquote> <ul> <li> <p>Если транзакция открывается только для чтения (SELECTs), то при <a href="/blog/2025/transaction-isolation-issues/">уровне изоляции</a> Read Committed её лучше убрать, т.к. “толку” от неё не будет, и это позволит избавиться от idle-in-transaction-соединений. А вот если нужен “толк”, тогда нужно повышать уровень изоляции, как минимум, до Repeatable Read, но такое нужно далеко не каждому.</p> </li> <li> <p>Для минимизации времени блокировок в БД все UPDATEs в коде нужно сместить ближе к месту закрытия транзакции. Конечно, это не избавит от idle-in-transaction-соединений, но это лучше, чем ничего.</p> </li> <li> <p>Пессимистичную блокировку следует применять, если много коллизий (высокая конкурентность при изменениях). Однако часто достаточно оптимистичной блокировки, которая избавляет от необходимости явного открытия обрамляющей транзакции, следовательно, от описанных выше проблем. Если же пессимистичная блокировка всё-таки нужна, то её можно реализовать не на уровне БД, а с помощью внешних механизмов (например, key-value-хранилищ).</p> </li> <li> <p>Медленные запросы могут исчерпать пул соединений, даже если таких запросов не очень много. Поэтому контролируем время выполнения запросов и анализируем планы запросов (explain). Частые проблемы: нет индексов на внешние ключи (foreign keys); используется <a href="https://jpoint.ru/archive/2022/talks/5d1a6b1be31c37d0e2b38f36b440fe15/" rel="external nofollow noopener" target="_blank">антипаттерн OrIsNull</a>; используется offset pagination (часто в сочетании с OrIsNull) вместо <a href="https://jpoint.ru/archive/2023/talks/7c6a25d123b441c68a48c1da157e3f38/" rel="external nofollow noopener" target="_blank">keyset pagination</a>; выбираются лишние данные (особенно <a href="https://www.postgresql.org/docs/current/storage-toast.html" rel="external nofollow noopener" target="_blank">TOAST</a>).</p> </li> </ul> </div> </article> <br> <br> <div class="card"> <div class="card-body"> <h4 class="card-title">Понравилась статья?</h4> <p class="card-text"> Посмею напомнить, что у меня есть Telegram-канал <a href="https://t.me/arch_and_dev/79" rel="external nofollow noopener" target="_blank">Архитектоника в ИТ</a>, где я публикую материал на похожие темы примерно раз в неделю. Подписчики меня мотивируют, но ещё больше мотивируют живые дискуссии, ведь именно в них рождается истина. Поэтому подписывайтесь на канал и будем оставаться на связи! ;-) </p> <p class="card-text">Статьи из той же категории:</p> <ul class="list-disc pl-8"> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ontico-conf-transformation/">Трансформация конференций</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/9-fallacies-distributed-computing/">9 архитектурных заблуждений о распределённых системах</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/connascence/">Порочные связи между компонентами</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/decomposition-in-the-style-of-quantum-architecture/">Декомпозиция в стиле квантовой архитектуры</a> </p> </li> <li class="my-2"> <p class="card-text"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/basic-elements-of-an-architectural-framework/">Базовые элементы архитектурного фреймворка</a> </p> </li> </ul> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Александр Межов. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Напечатайте что-нибудь для поиска"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>